name: Infrastructure Service CI

on:
    workflow_call:
        inputs:
            service_name:
                required: true
                type: string
                description: "Service name (e.g., nginx, tailscale)"
            service_port:
                required: true
                type: number
                description: "Service port number"
            validate_config:
                required: false
                type: boolean
                default: false
                description: "Whether to validate configuration before build"
            validation_command:
                required: false
                type: string
                default: ""
                description: "Command to run for configuration validation"
            dockerfile_path:
                required: false
                type: string
                default: "./Dockerfile"
                description: "Path to Dockerfile (e.g., ./Dockerfile or ./docker/Dockerfile)"
        secrets:
            DOCKER_TOKEN:
                required: true
                description: "Docker Hub access token"

env:
    DOCKER_USERNAME: nuniesmith
    DOCKER_REPO: nuniesmith/fks

jobs:
    ci:
        runs-on: ubuntu-latest
        concurrency:
            group: ${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: true

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Validate configuration
              if: inputs.validate_config
              run: |
                  if [ -n "${{ inputs.validation_command }}" ]; then
                    echo "Running validation: ${{ inputs.validation_command }}"
                    ${{ inputs.validation_command }}
                  else
                    echo "No validation command provided, skipping"
                  fi

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Docker metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.DOCKER_REPO }}
                  tags: |
                      type=raw,value=${{ inputs.service_name }}-latest,enable={{is_default_branch}}
                      type=sha,prefix=${{ inputs.service_name }}-,format=short
                      type=ref,event=branch,prefix=${{ inputs.service_name }}-
                      type=semver,pattern={{version}},prefix=${{ inputs.service_name }}-
                      type=semver,pattern={{major}}.{{minor}},prefix=${{ inputs.service_name }}-

            - name: Log in to DockerHub
              uses: docker/login-action@v3
              with:
                  username: ${{ env.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ${{ inputs.dockerfile_path }}
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha,scope=${{ inputs.service_name }}
                  cache-to: type=gha,mode=max,scope=${{ inputs.service_name }}

            - name: Image digest
              run: echo ${{ steps.meta.outputs.digest }}

            - name: Summary
              run: |
                  echo "### âœ… Infrastructure Service CI Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Service**: ${{ inputs.service_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Port**: ${{ inputs.service_port }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Image**: \`${{ env.DOCKER_REPO }}:${{ inputs.service_name }}-latest\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ³ Docker image pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
