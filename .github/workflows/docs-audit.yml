name: Documentation Audit

on:
    workflow_call:
        inputs:
            docs_dir:
                required: false
                type: string
                default: "docs"
                description: "Documentation directory to audit"
            audit_script:
                required: false
                type: string
                default: "scripts/docs/audit_files.py"
                description: "Path to custom audit script"
            python_version:
                required: false
                type: string
                default: "3.12"
                description: "Python version to use"
            post_pr_comment:
                required: false
                type: boolean
                default: true
                description: "Post audit results as PR comment"

jobs:
    audit:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ inputs.python_version }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  pip install --upgrade pip
                  if [ -f "requirements.txt" ]; then
                    pip install -r requirements.txt || true
                  fi

            - name: Run documentation audit
              id: audit
              run: |
                  mkdir -p audit-results

                  if [ -f "${{ inputs.audit_script }}" ]; then
                    echo "Running custom audit script: ${{ inputs.audit_script }}"
                    python ${{ inputs.audit_script }} \
                      --docs-dir ${{ inputs.docs_dir }} \
                      --output audit-results/docs-audit-report.json \
                      --summary
                  else
                    echo "No custom audit script found. Running basic audit..."
                    
                    # Basic audit: count files, check for empty files
                    TOTAL_FILES=$(find ${{ inputs.docs_dir }} -type f -name "*.md" 2>/dev/null | wc -l || echo 0)
                    EMPTY_FILES=$(find ${{ inputs.docs_dir }} -type f -name "*.md" -empty 2>/dev/null | wc -l || echo 0)
                    
                    # Create basic report
                    cat > audit-results/docs-audit-report.json <<EOF
                  {
                    "total_files": $TOTAL_FILES,
                    "empty_files_count": $EMPTY_FILES,
                    "audit_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
                    "recommendations": [
                      "Consider adding a custom audit script at ${{ inputs.audit_script }}"
                    ]
                  }
                  EOF
                  fi

                  echo "audit_completed=true" >> $GITHUB_OUTPUT
              continue-on-error: true

            - name: Generate audit summary
              if: steps.audit.outputs.audit_completed == 'true'
              run: |
                  echo "### üìä Documentation Audit Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ -f "audit-results/docs-audit-report.json" ]; then
                    TOTAL=$(jq -r '.total_files // 0' audit-results/docs-audit-report.json)
                    echo "**Total Files**: $TOTAL" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    
                    # Extract other metrics if available
                    if jq -e '.empty_files_count' audit-results/docs-audit-report.json > /dev/null 2>&1; then
                      EMPTY=$(jq -r '.empty_files_count // 0' audit-results/docs-audit-report.json)
                      echo "- Empty files: $EMPTY" >> $GITHUB_STEP_SUMMARY
                    fi
                    
                    # Add recommendations if available
                    if jq -e '.recommendations' audit-results/docs-audit-report.json > /dev/null 2>&1; then
                      RECS=$(jq -r '.recommendations[]? // empty' audit-results/docs-audit-report.json)
                      if [ -n "$RECS" ]; then
                        echo "" >> $GITHUB_STEP_SUMMARY
                        echo "**Recommendations**:" >> $GITHUB_STEP_SUMMARY
                        echo "$RECS" | while read -r line; do
                          echo "- $line" >> $GITHUB_STEP_SUMMARY
                        done
                      fi
                    fi
                  else
                    echo "‚ö†Ô∏è  No audit report generated" >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Upload audit report
              uses: actions/upload-artifact@v4
              with:
                  name: docs-audit-report
                  path: audit-results/
                  retention-days: 7
              if: always()

            - name: Comment on PR
              if: inputs.post_pr_comment && github.event_name == 'pull_request' && steps.audit.outputs.audit_completed == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      let comment = '## üìä Documentation Audit Results\n\n';

                      if (fs.existsSync('audit-results/docs-audit-report.json')) {
                        try {
                          const report = JSON.parse(fs.readFileSync('audit-results/docs-audit-report.json', 'utf8'));
                          comment += `**Total Files**: ${report.total_files || 0}\n\n`;
                          
                          if (report.empty_files_count !== undefined) {
                            comment += `**Empty Files**: ${report.empty_files_count}\n\n`;
                          }
                          
                          if (report.recommendations && report.recommendations.length > 0) {
                            comment += `### üí° Recommendations\n`;
                            report.recommendations.forEach((rec, i) => {
                              comment += `${i + 1}. ${rec}\n`;
                            });
                          }
                        } catch (error) {
                          comment += `‚ö†Ô∏è  Could not parse audit report: ${error.message}\n`;
                        }
                      } else {
                        comment += `‚ÑπÔ∏è  No detailed audit report available.\n`;
                      }

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });
              continue-on-error: true
