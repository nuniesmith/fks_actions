name: Build Desktop App

on:
  workflow_call:
    inputs:
      app_path:
        description: "Path to desktop app directory (e.g., apps/desktop)"
        required: true
        type: string
      package_name:
        description: "Package name for artifacts (e.g., fks-desktop)"
        required: true
        type: string
      gradle_task:
        description: "Gradle task to run (e.g., :desktopApp:packageReleaseDeb)"
        required: false
        type: string
        default: ":desktopApp:packageReleaseDeb :desktopApp:packageReleaseRpm"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper

      - name: Grant execute permission for gradlew
        working-directory: ${{ inputs.app_path }}
        run: chmod +x gradlew

      - name: Build packages
        working-directory: ${{ inputs.app_path }}
        run: ./gradlew ${{ inputs.gradle_task }}
        continue-on-error: false

      - name: Find package files
        id: find-packages
        working-directory: ${{ inputs.app_path }}
        run: |
          DEB_FILE=$(find desktopApp/build/compose/binaries/main-release/deb -name "*.deb" 2>/dev/null | head -1 || echo "")
          RPM_FILE=$(find desktopApp/build/compose/binaries/main-release/rpm -name "*.rpm" 2>/dev/null | head -1 || echo "")

          if [ -n "$DEB_FILE" ]; then
            echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT
            echo "Found DEB: $DEB_FILE"
          fi

          if [ -n "$RPM_FILE" ]; then
            echo "rpm_file=$RPM_FILE" >> $GITHUB_OUTPUT
            echo "Found RPM: $RPM_FILE"
          fi

      - name: Upload .deb artifact
        if: steps.find-packages.outputs.deb_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package_name }}-deb
          path: ${{ inputs.app_path }}/${{ steps.find-packages.outputs.deb_file }}
          retention-days: 30

      - name: Upload .rpm artifact
        if: steps.find-packages.outputs.rpm_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package_name }}-rpm
          path: ${{ inputs.app_path }}/${{ steps.find-packages.outputs.rpm_file }}
          retention-days: 30

      - name: Output package paths
        id: output-paths
        run: |
          echo "deb_path=${{ steps.find-packages.outputs.deb_file }}" >> $GITHUB_OUTPUT
          echo "rpm_path=${{ steps.find-packages.outputs.rpm_file }}" >> $GITHUB_OUTPUT

    outputs:
      deb_file: ${{ steps.find-packages.outputs.deb_file }}
      rpm_file: ${{ steps.find-packages.outputs.rpm_file }}
